<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Ambulance Tracking System</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .stats-panel {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .available {
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
        }

        .fastest {
            animation: pulse 1.5s infinite;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 10px;
            padding: 10px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ambulance-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .list-item-nearby {
            background: rgba(0, 255, 136, 0.2) !important;
            border-left: 5px solid #00ff88;
        }

        .list-item-fastest {
            background: linear-gradient(90deg, #ffeb3b, #ffd700) !important;
            border-left: 5px solid #ff6b6b;
        }
    </style>
</head>
<body>
<div class="container-fluid py-5">
    <!-- HEADER -->
    <div class="text-center text-white mb-5">
        <h1 class="display-4 fw-bold mb-3">Live Ambulance Dashboard</h1>
        <p class="lead fs-4">Enter your location to find available ambulances nearby</p>
    </div>

    <!-- SEARCH SECTION -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="search-section text-center">
                <h3 class="mb-4 text-primary">Enter Your Location</h3>
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <input type="text" id="placeSearch" class="form-control form-control-lg"
                               placeholder="Enter place name e.g., Connaught Place Delhi, Bandra Mumbai, etc.">
                    </div>
                    <div class="col-md-2">
                        <button id="searchBtn" class="btn btn-primary btn-lg w-100">Search</button>
                    </div>
                    <div class="col-md-2">
                        <button id="demoBtn" class="btn btn-outline-primary btn-lg w-100">Demo</button>
                    </div>
                </div>
                <div id="searchStatus" class="mt-3 p-3 rounded fw-bold"></div>
            </div>
        </div>
    </div>

    <!-- STATS PANEL -->
    <div id="statsPanel" class="row justify-content-center" style="display:none;">
        <div class="col-lg-10">
            <div class="stats-panel">
                <div class="row">
                    <div class="col-md-3 stat-box">
                        <div class="stat-number" id="totalNearby">0</div>
                        <div>Total Nearby (5km)</div>
                    </div>
                    <div class="col-md-3 stat-box">
                        <div class="stat-number available" id="availableCount">0</div>
                        <div><strong>AVAILABLE</strong></div>
                    </div>
                    <div class="col-md-3 stat-box">
                        <div class="stat-number text-warning" id="enrouteCount">0</div>
                        <div>En Route</div>
                    </div>
                    <div class="col-md-3 stat-box">
                        <div class="stat-number fastest" id="fastestAmbulance">-</div>
                        <div id="fastestDistance">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAP & LIST -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="bg-white p-4 rounded shadow-lg">
                <h4 class="mb-3">Live Tracking Map</h4>
                <div id="map"></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="bg-white p-4 rounded shadow-lg h-100">
                <h4 class="mb-3">Available Ambulances</h4>
                <div id="ambulanceList" class="list-group ambulance-list"></div>
            </div>
        </div>
    </div>

    <!-- AMBULANCE ACCEPT BUTTON -->
    <div class="text-center mt-4">
        <button id="ambulanceAcceptBtn" class="btn btn-success btn-lg" disabled>
            Ambulance Accept
        </button>
    </div>
</div>

<script>
    // Initialize map
    const map = L.map('map').setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap contributors'
    }).addTo(map);

    // Ambulance data
    let ambulances = [
        // DELHI
        {id: 'AMB001', lat: 28.6139, lng: 77.2090, status: 'available'},
        {id: 'AMB002', lat: 28.6315, lng: 77.2199, status: 'available'},
        {id: 'AMB003', lat: 28.6500, lng: 77.2500, status: 'available'},
        {id: 'AMB004', lat: 28.6200, lng: 77.2200, status: 'available'},
        {id: 'AMB005', lat: 28.6000, lng: 77.2000, status: 'available'},
        // MUMBAI
        {id: 'AMB006', lat: 19.0760, lng: 72.8777, status: 'available'},
        {id: 'AMB007', lat: 19.0610, lng: 72.8348, status: 'available'},
        {id: 'AMB008', lat: 19.0500, lng: 72.8500, status: 'available'},
        {id: 'AMB009', lat: 19.0700, lng: 72.8300, status: 'available'},
        // BANGALORE
        {id: 'AMB010', lat: 12.9716, lng: 77.5946, status: 'available'},
        {id: 'AMB011', lat: 12.9279, lng: 77.6285, status: 'available'},
        {id: 'AMB012', lat: 12.9500, lng: 77.6000, status: 'available'},
        // CHENNAI
        {id: 'AMB013', lat: 13.0827, lng: 80.2707, status: 'available'},
        {id: 'AMB014', lat: 13.0500, lng: 80.2500, status: 'available'},
        // EXTRA
        {id: 'AMB015', lat: 22.5726, lng: 88.3639, status: 'available'},
        {id: 'AMB016', lat: 17.3850, lng: 78.4867, status: 'available'},
        {id: 'AMB017', lat: 26.9124, lng: 75.7873, status: 'available'},
        {id: 'AMB018', lat: 22.3072, lng: 73.1812, status: 'available'},
        // SOME EN ROUTE
        {id: 'AMB019', lat: 28.5800, lng: 77.1800, status: 'enroute'},
        {id: 'AMB020', lat: 19.0800, lng: 72.8800, status: 'enroute'},
        {id: 'AMB021', lat: 12.9600, lng: 77.6100, status: 'hospital'}
    ];

    let markers = {};
    let userMarker = null;
    let userLocation = null;

    const icons = {
        available: L.divIcon({
            html: '<div style="background:#00ff88;color:black;font-weight:bold;padding:4px 8px;border-radius:12px;font-size:11px;margin-bottom:2px;">AVAILABLE</div>',
            className: 'text-center',
            iconSize: [50, 65],
            iconAnchor: [25, 65]
        }),
        enroute: L.divIcon({
            html: '<div style="background:#ffaa00;color:black;font-weight:bold;padding:2px 6px;border-radius:8px;font-size:10px;">EN ROUTE</div>',
            iconSize: [45, 55],
            iconAnchor: [22, 55]
        }),
        hospital: L.divIcon({
            html: '<div style="background:#ff4d4d;color:white;font-weight:bold;padding:3px 7px;border-radius:10px;font-size:10px;">HOSPITAL</div>',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        }),
        user: L.divIcon({
            html: '<div style="background:#4488ff;color:white;font-weight:bold;padding:3px 8px;border-radius:10px;font-size:11px;margin-top:5px;">YOU</div>',
            iconSize: [45, 60],
            iconAnchor: [22, 60]
        })
    };

    // Search button
    document.getElementById('searchBtn').onclick = async () => {
        const query = document.getElementById('placeSearch').value.trim();
        if (!query) {
            showStatus("Please enter a location", "warning");
            return;
        }

        showStatus("Searching for ambulances...", "info");

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, India&limit=1&countrycodes=in`);
            const data = await response.json();

            if (data.length === 0) {
                showStatus("Location not found. Try another place name.", "danger");
                return;
            }

            const place = data[0];
            userLocation = {
                lat: parseFloat(place.lat),
                lng: parseFloat(place.lon),
                name: place.display_name.split(',')[0]
            };

            updateUserMarker();
            findNearbyAmbulances();
            showStatus(`Found ${userLocation.name}`, "success");
        } catch (error) {
            showStatus("Search failed. Please try again.", "danger");
        }
    };

    // Demo button
    document.getElementById('demoBtn').onclick = () => {
        const demos = [
            {name: "Connaught Place Delhi", lat: 28.6315, lng: 77.2199},
            {name: "Bandra Mumbai", lat: 19.0610, lng: 72.8348},
            {name: "Koramangala Bangalore", lat: 12.9279, lng: 77.6285},
            {name: "T Nagar Chennai", lat: 13.0400, lng: 80.2300}
        ];
        const demo = demos[Math.floor(Math.random() * demos.length)];
        document.getElementById('placeSearch').value = demo.name;
        userLocation = {lat: demo.lat, lng: demo.lng, name: demo.name};
        updateUserMarker();
        findNearbyAmbulances();
    };

    function showStatus(message, type) {
        const statusEl = document.getElementById('searchStatus');
        statusEl.innerHTML = `<div class="alert alert-${type} mb-0">${message}</div>`;
    }

    function updateUserMarker() {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([userLocation.lat, userLocation.lng], {icon: icons.user})
            .bindPopup(`<b>Your Location</b><br>${userLocation.name}`)
            .addTo(map);
        map.setView([userLocation.lat, userLocation.lng], 12);
    }

    function findNearbyAmbulances() {
        if (!userLocation) return;

        ambulances.forEach(amb => {
            amb.distance = haversineDistance(userLocation.lat, userLocation.lng, amb.lat, amb.lng);
        });

        const nearby = ambulances.filter(amb => amb.distance <= 5);
        const available = nearby.filter(amb => amb.status === 'available').sort((a, b) => a.distance - b.distance);
        const enroute = nearby.filter(amb => amb.status === 'enroute');

        document.getElementById('statsPanel').style.display = 'block';
        document.getElementById('totalNearby').textContent = nearby.length;
        document.getElementById('availableCount').textContent = available.length;
        document.getElementById('enrouteCount').textContent = enroute.length;

        if (available.length > 0) {
            const fastest = available[0];
            document.getElementById('fastestAmbulance').textContent = fastest.id;
            document.getElementById('fastestDistance').textContent = fastest.distance.toFixed(1) + " km";
            document.getElementById('ambulanceAcceptBtn').disabled = false;
        } else {
            document.getElementById('fastestAmbulance').textContent = "None";
            document.getElementById('fastestDistance').textContent = "-";
            document.getElementById('ambulanceAcceptBtn').disabled = true;
        }

        updateAmbulanceList(available);
        updateMap();
    }

    function updateAmbulanceList(available) {
        const listEl = document.getElementById('ambulanceList');

        if (available.length === 0) {
            listEl.innerHTML = `
                <div class="list-group-item text-center text-muted p-5">
                    No available ambulances nearby
                </div>`;
            return;
        }

        const itemsHtml = available.map((amb, index) => {
            const isFastest = index === 0;
            return `
                <div class="list-group-item list-group-item-action p-3 mb-2 rounded ${isFastest ? 'list-item-fastest' : 'list-item-nearby'}">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h5 class="mb-1">
                                ${amb.id}
                                <span class="badge bg-success ms-2">AVAILABLE</span>
                                ${isFastest ? '<span class="badge bg-danger ms-1">FASTEST</span>' : ''}
                            </h5>
                            <small class="text-muted">Live tracking active</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold fs-5 text-success">${amb.distance.toFixed(1)} km away</div>
                            <button class="btn btn-success btn-sm mt-2">CALL NOW</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        listEl.innerHTML = itemsHtml;
    }

    function updateMap() {
        Object.values(markers).forEach(marker => map.removeLayer(marker));
        markers = {};

        ambulances.forEach(amb => {
            const icon = amb.status === 'available' ? icons.available
                : amb.status === 'enroute' ? icons.enroute
                : icons.hospital;

            let popupContent = `
                <div class="p-3">
                    <h6>${amb.id}</h6>
                    <span class="badge ${amb.status === 'available' ? 'bg-success' : amb.status === 'enroute' ? 'bg-warning' : 'bg-danger'}">
                        ${amb.status.toUpperCase()}
                    </span>
            `;

            if (userLocation && typeof amb.distance === 'number') {
                popupContent += `<br><strong>${amb.distance.toFixed(1)} km away</strong>`;
            }

            popupContent += `</div>`;

            const marker = L.marker([amb.lat, amb.lng], {icon})
                .bindPopup(popupContent)
                .addTo(map);

            markers[amb.id] = marker;
        });
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // Live tracking simulation
    setInterval(() => {
        ambulances.forEach(amb => {
            amb.lat += (Math.random() - 0.5) * 0.003;
            amb.lng += (Math.random() - 0.5) * 0.003;
            if (userLocation) {
                amb.distance = haversineDistance(userLocation.lat, userLocation.lng, amb.lat, amb.lng);
            }
        });
        if (userLocation) {
            findNearbyAmbulances();
        }
        updateMap();
    }, 3000);

    // Enter key support
    document.getElementById('placeSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('searchBtn').click();
        }
    });

    // NAVIGATE TO SECOND PAGE ON ACCEPT
    document.getElementById('ambulanceAcceptBtn').addEventListener('click', () => {
        // first.html and second.html must be in same folder
        window.location.href = 'second.html';
    });

    // Initial map update
    updateMap();
</script>
</body>
</html>
